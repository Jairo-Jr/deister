<xsql-script name='crp_ibth_picking_pedidos'>
    <body>

        <!-- CREACION DE VTABLE -->
    	<vtable name='v_pedidosh'>
            <column name='docser' type='string' />
            <column name='cabid' type='string' />
        </vtable>

        <vtable name='v_pedidosl'>
            <column name='numline' type='string' />
            <column name='qtyrequested' type='string' />
            <column name='qtyserved' type='string' />
            <column name='productcode' type='string' />
            <column name='id_head' type='string' />
        </vtable>

        <!-- ITERAR LAS CABECERAS -->
        <foreach>
            <select prefix='pc_h_'>
                <columns>
                    orderclient,
                    id_finishedorders_h
                </columns>
                <from table='crp_ibth_setfinishedorders_h' />
                <where>
                    state = 'P'
                </where>
            </select>
            <do>

                <select prefix='gcomsolh_'>
                    <columns>
                        gcomsolh.cabid,
                        gcomsolh.estcab,
                        gcomsolh.estado,
                        gcomsolh.delega,
                        gcomsolh.depart,
                        gcomsolh.codalm
                    </columns>
                    <from table='gcomsolh' />
                    <where>
                        gcomsolh.docser = <pc_h_orderclient />  
                    </where>
                </select>

                <!-- VALIDA LA EXISTENCIA DEL PEDIDO DE COMPRA -->
                <if>
                    <expr>
                        <or>
                            <ne><gcomsolh_estcab/>V</ne>   
                            <eq><gcomsolh_estado/>S</eq>  <!-- Servida -->
                            <eq><gcomsolh_estado/>A</eq>  <!-- Anulada -->
                        </or>   
                    </expr>
                    <then>
                        
                        <!-- NO SE GENERA PICKING -->
                        <!-- SE ACTUALIZA EL ESTADO A ERROR DEL PEDIDO CONSIGNADO POR IBTH -->
                        <update table='crp_ibth_setfinishedorders_h'>
                            <column name='state'>E</column>
                            <column name='message_error'>Solicitud de consumo no esta validada o se encuentra con estado Servida o Anulada.</column>
                            <column name='date_error'> <date.today /> </column>
                            <where>
                                id_finishedorders_h = <pc_h_id_finishedorders_h />  
                            </where>
                        </update>

                    </then>
                    <else>
                        <!-- SI EL SVLC ES VALIDA Y NO ESTA SERVIDA POR COMPLETO O ANULADA -->
                        <!-- SE ITERA LAS LINEAS DEL PEDIDO -->
                        <foreach>
                            <select prefix='pc_l_'>
                                <columns>
                                    numline,
                                    qtyrequested,
                                    qtyserved,
                                    productcode,
                                    id_finishedorders_h
                                </columns>
                                <from table='crp_ibth_setfinishedorders_l' />
                                <where>
                                    id_finishedorders_h = <pc_h_id_finishedorders_h />
                                </where>
                            </select>
                            <do>
                                <!-- SE VALIDA LA CONCORDANCIA DE LOS ARTICULOS -->

                                <!-- ASIGNACION DE LAS LINEAS A LA VTABLE -->
                                <vtable.insert name='v_pedidosl'>
                                    <column name='numline' > <pc_l_numline /> </column>
                                    <column name='qtyrequested' > <pc_l_qtyrequested /> </column>
                                    <column name='qtyserved' > <pc_l_qtyserved /> </column>
                                    <column name='productcode' > <pc_l_productcode /> </column>
                                    <column name='id_head' > <pc_l_id_finishedorders_h /> </column>
                                </vtable.insert>
                            </do>
                        </foreach>
                    </else>
                </if>
                <!-- ASIGNACION DE LAS CABECERAS A LA VTABLE -->
                <vtable.insert name='v_pedidosh'>
                    <column name='docser'><pc_h_orderclient /></column>
                    <column name='cabid'><pc_h_id_finishedorders_h /></column>
                </vtable.insert>
            </do>
        </foreach>

        <return>
            <!-- <v_pedidosh /> -->
            <v_pedidosl />
        </return>

    </body>
</xsql-script>