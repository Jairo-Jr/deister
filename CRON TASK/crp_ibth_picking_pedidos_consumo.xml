<xsql-script name='crp_ibth_picking_pedidos'>
    <body>

        <!-- VARIBALES -->
        <set name='m_pedido_valido'>1</set>

        <!-- <vtable name='v_pedidosh'>
            <column name='docser' type='string' />
            <column name='cabid' type='string' />
        </vtable>

        <vtable name='v_pedidosl'>
            <column name='numline' type='string' />
            <column name='qtyrequested' type='string' />
            <column name='qtyserved' type='string' />
            <column name='productcode' type='string' />
            <column name='id_head' type='string' />
        </vtable> -->

        <!-- ITERAR LAS CABECERAS (IBTH) -->
        <foreach>
            <select prefix='pc_h_'>
                <columns>
                    orderclient,
                    id_finishedorders_h
                </columns>
                <from table='crp_ibth_setfinishedorders_h' />
                <where>
                    state = 'P'
                </where>
            </select>
            <do>
                <!-- SE INICIA COMO NO VALIDA -->
                <set name='m_pedido_valido'>0</set>

                <!-- CREACION DE VTABLE -->
                <vtable name='v_pedidosh'>
                    <column name='docser' type='string' />
                    <column name='cabid' type='string' />
                </vtable>

                <vtable name='v_pedidosl'>
                    <column name='numline' type='string' />
                    <column name='qtyrequested' type='string' />
                    <column name='qtyserved' type='string' />
                    <column name='productcode' type='string' />
                    <column name='id_head' type='string' />
                </vtable>

                <select prefix='gcomsolh_'>
                    <columns>
                        gcomsolh.cabid,
                        gcomsolh.estcab,
                        gcomsolh.estado,
                        gcomsolh.delega,
                        gcomsolh.depart,
                        gcomsolh.auxnum1,
                        gcomsolh.codalm
                    </columns>
                    <from table='gcomsolh' />
                    <where>
                        gcomsolh.docser = <pc_h_orderclient />  
                    </where>
                </select>

                <!-- El estado de la solicitud debe ser validado, no encontrarse servida por completo ni anulada y no haber sido enviado a IBTH  -->
                <if>
                    <expr>
                        <or>
                            <ne> <gcomsolh_estcab/>V</ne>  <!-- Valida --> 
                            <eq> <gcomsolh_estado/>S</eq>  <!-- Servida -->
                            <eq> <gcomsolh_estado/>A</eq>  <!-- Anulada -->
                            <eq> <gcomsolh_auxnum1/>1</eq>  <!-- Enviado -->
                        </or>   
                    </expr>
                    <then>
                        
                        <!-- NO SE GENERA PICKING -->
                        <!-- SE ACTUALIZA EL ESTADO A ERROR DEL PEDIDO CONSIGNADO POR IBTH -->
                        <update table='crp_ibth_setfinishedorders_h'>
                            <column name='state'>E</column>
                            <column name='message_error'>Solicitud de consumo no esta validada, se encuentra con estado Servida o Anulada o ya fue enviada a IBTH.</column>
                            <column name='date_error'> <date.today /> </column>
                            <where>
                                id_finishedorders_h = <pc_h_id_finishedorders_h />
                            </where>
                        </update>

                        <!-- CONTINUA CON LA SIGUIENTE ITERACION -->
                        <foreach.continue />

                    </then>
                    <else>
                        <!-- LA SVLC ES VALIDA (cabecera) -->
                        <!-- ASIGNACION DE LAS CABECERAS A LA VTABLE -->
                        <vtable.insert name='v_pedidosh'>
                            <column name='docser'><pc_h_orderclient /></column>
                            <column name='cabid'><pc_h_id_finishedorders_h /></column>
                        </vtable.insert>

                        <!-- SE ITERA LAS LINEAS DEL PEDIDO -->
                        <foreach>
                            <select prefix='pc_l_'>
                                <columns>
                                    numline,
                                    qtyrequested,
                                    qtyserved,
                                    productcode,
                                    id_finishedorders_h
                                </columns>
                                <from table='crp_ibth_setfinishedorders_l' />
                                <where>
                                    id_finishedorders_h = <pc_h_id_finishedorders_h />
                                </where>
                            </select>
                            <do>
                                <!-- SE OBTIENE EL ARTICULO ASOCIADO AL PEDIDO DE CONSUMO -->
                                <select prefix='gcomsoll_'>
                                    <columns>
                                        linid,
                                        cabid,
                                        codart,
                                        cansol,
                                        canser
                                    </columns>
                                    <from table='gcomsoll' />
                                    <where>
                                        cabid = <gcomsolh_cabid />
                                        AND codart = <pc_l_productcode/>
                                        AND cansol >= <pc_l_qtyrequested />
                                    </where>
                                </select>

                                <!-- SE VALIDA LA CONCORDANCIA DE LOS ARTICULOS -->
                                <if>
                                    <expr>
                                        <isnull><gcomsoll_linid /></isnull>
                                    </expr>
                                    <then>
                                        <!-- SE ACTUALIZA EL ESTADO A ERROR DEL PEDIDO CONSIGNADO POR IBTH -->
                                        <update table='crp_ibth_setfinishedorders_h'>
                                            <column name='state'>E</column>
                                            <column name='message_error'><string>Error con el articulo [<pc_l_productcode/>].</string></column>
                                            <column name='date_error'> <date.today /> </column>
                                            <where>
                                                id_finishedorders_h = <pc_l_id_finishedorders_h />
                                            </where>
                                        </update>
                                        <!--  -->
                                        <set name='m_pedido_valido'>0</set>

                                        <foreach.exit/>
                                    </then>
                                    <else>
                                        <!-- EL ARTICULO ES VALIDO -->
                                        <set name='m_pedido_valido'>1</set>

                                        <!-- SE AGREGA LAS LINEAS -->
                                        <vtable.insert name='v_pedidosl'>
                                            <column name='numline' > <pc_l_numline /> </column>
                                            <column name='qtyrequested' > <pc_l_qtyrequested /> </column>
                                            <column name='qtyserved' > <pc_l_qtyserved /> </column>
                                            <column name='productcode' > <pc_l_productcode /> </column>
                                            <column name='id_head' > <pc_l_id_finishedorders_h /> </column>
                                        </vtable.insert>
                                        <foreach.continue />
                                    </else>
                                </if>
                                
                            </do>
                        </foreach>

                        <if>
                            <expr>
                                <eq><m_pedido_valido/>1</eq>  <!-- Pedido es valido -->
                            </expr>
                            <then>
                                <!-- INICIO DE GENERAR PICKING -->

                                <!-- SE GENERA PROPUESTA DE MOVIMIENTO -->
                                <call name='gmovproh_gcomsolh' into='log_id'>
                                    <null />
                                    <number>1</number>
                                    <gcomsolh_cabid/>
                                    <null />
                                    <null />
                                    <string>*</string>
                                    <string>*</string>
                                    <string>*</string>
                                    <string>%</string>
                                    <null/>
                                    <string>%</string>
                                    <null/>
                                    <string>*</string>
                                    <string>*</string>
                                </call>

                                <!-- ================================================================ -->
                                <!-- Comprobar que se ha generado la propuesta de movimiento          -->
                                <!-- ================================================================ -->
                                <select prefix='gmovproh_'>
                                    <columns>
                                        gmovproh.cabid,
                                        gmovproh.docser
                                    </columns>
                                    <from table='gmovproh' />
                                    <where>
                                        
                                            gmovproh.cabid IN (SELECT gmovprol.cabid 
                                                                FROM gmovprol, 
                                                                    gcomsoll 
                                                                WHERE gmovprol.tabori = 'gcomsolh' 
                                                                AND gmovprol.linori = gcomsoll.linid 
                                                                AND gmovprol.cabori = <gcomsolh_cabid />)
                                        AND gmovproh.estado = 'N' <!-- No realizada -->
                                    </where>
                                </select>

                                <if>
                                    <expr>
                                        <isnull><gmovproh_cabid /></isnull>
                                    </expr>
                                    <then>
                                        <!-- NO SE GENERA PICKING -->
                                        <!-- SE ACTUALIZA EL ESTADO A ERROR DEL PEDIDO CONSIGNADO POR IBTH -->
                                        <update table='crp_ibth_setfinishedorders_h'>
                                            <column name='state'>E</column>
                                            <column name='message_error'>No se ha generado picking.</column>
                                            <column name='date_error'> <date.today /> </column>
                                            <where>
                                                id_finishedorders_h = <pc_h_id_finishedorders_h />
                                            </where>
                                        </update>
                                        <!-- CONTINUA CON LA SIGUIENTE ITERACION -->
                                        <foreach.continue />
                                    </then>
                                </if>

                                

                            </then>
                        </if>

                    </else>
                </if>
                
            </do>
        </foreach>

        <return>
            <!-- <v_pedidosh /> -->
            <v_pedidosl />
        </return>

    </body>
</xsql-script>